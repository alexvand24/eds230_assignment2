---
title: "EDS 230 Assignment 2"
author: "Elmera Azadpour, Mia Forsline, Alex Vand"
date: "2022-04-12"
output: html_document
---

# Introduction

The goal of this assignment is to build a simple model to predict annual almond yield based on the paper by [Lobell et al. (2006)](https://www.sciencedirect.com/science/article/pii/S016819230600308X).

# Set up: Load necessary libraries and scripts

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install packages if necessary, then load libraries
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}

librarian::shelf(
  here,
  lubridate,
  tidyverse)

#read in the almond_yield_anomaly and almond_yield_anomaly_annual R scripts in order to use the functions in this RMD 
source(here("functions", "almond_yield_anomaly.R"))
source(here("functions", "almond_yield_anomaly_annual.R"))
```

# Function description

## Key

-   `variable_name` = description [units]

## Inputs

-   `temp` = average minimum temperature in February [degrees C]
-   `precip` = average precipitation in January [mm]

## Parameters

-   `temp_coeff1`
-   `temp_coeff2`
-   `precip_coeff1`
-   `precip_coeff2`

Note that all parameter values are based on the original paper.

## Outputs

-   `almond_yield_anomaly` = almond yield anomaly [ton/acre]

# Test the simple `almond_yield_anomaly()` function given one year's worth of temperature and precipitation data

```{r example}
almond_yield_anomaly(feb_temp_min = 25, 
                     jan_precip = 10)
```

# Read in climate data

```{r}
# read in the data from .txt file
clim_raw <- read.csv(file = "clim.txt", 
                     header = T, 
                     sep = "")

# clean data 
clim_data <- clim_raw %>% 
             janitor::clean_names() %>% 
             mutate(d = lubridate::as_date(d), #convert d column to Date format rather than a character 
                    year = lubridate::year(d))
```

# Use the `almond_yield_anomaly_annual()` function using coefficients from the paper
- Note that this function averages minimum February temperatures (ÂºC) and January precipitation (mm)
```{r}
# set coefficient parameter values 
temp_coeff1 <- -0.015
temp_coeff2 <- -0.0046
precip_coeff1 <- -0.07
precip_coeff2 <- 0.0043
constant <- 0.28

# calculate annual almond yield for each year
annual_almond_yield <- cbind(unique(clim_data$year), almond_yield_anomaly_annual(clim_data)) %>%  #create a matrix/array of dates and annual almond yields
  as.data.frame() %>% #transform into a data frame 
  rename(year = V1,
         yield = V2)
```

# Check the model outputs

```{r}
yield_1999 <- subset(annual_almond_yield, year == 1999)[[2]]
yield_1999

yield_2000 <- subset(annual_almond_yield, year == 2000)[[2]]
yield_2000

yield_2001 <- subset(annual_almond_yield, year == 2001)[[2]]
yield_2001
```

# Plot the annual trend in almond yield over time

```{r}
ggplot(annual_almond_yield, 
       aes(year, yield)) + 
  geom_line()+
  geom_point() +
  labs(x = "Year", y = "Almond Yield (tons/acre)") + 
  theme_classic()
```

# Results and conclusions

```{r}
max_yield <- max(annual_almond_yield$yield)
min_yield <- min(annual_almond_yield$yield)
avg_yield <- mean(annual_almond_yield$yield)
```

We built a simpler replica of the almond yield model built by Lobell et al. (2006) using two different functions. From 1988 to 2010, the average almond yield was `r avg_yield` tons/acre per year. During this time period, average almond yield peaked at `r max_yield` in 1994 while some years reported average almonnd yields of zero. 

Moving forward, it would be interesting to further investigate outlier years like 1994 to discern if that high of an average almond yield is feasible or if the model can be improved. 

# Generalize temp and precip inputs

```{r}
temp = function(minimum, month_number){
  
  # minimum = TRUE for minimum value // FALSE for maximum value
  # month = number (out of 12) of month of interest
  
 if (minimum == TRUE){
   
   temp <- min(clim_txt_data$tmin_c[clim_txt_data$month == month_number])
   
} else if (minimum == FALSE){
  
  temp <- max(clim_txt_data$tmax_c[clim_txt_data$month == month_number]) 
  
} else {
  
  print("Error: must select TRUE (1) or FALSE (0) for minimum input")
  
}
  
  return(temp)
                        }
```

```{r}
precip = function(month){
  
  # month = number (out of 12) of month of interest
  
   
   precip <- mean(clim_txt_data$precip[clim_txt_data$month == month_number])
   
  
  return(precip)
                        }
```
