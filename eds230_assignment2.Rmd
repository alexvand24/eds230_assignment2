---
title: "EDS 230 Assignment 2"
author: "Elmera Azadpour, Mia Forsline, Alex Vand"
date: "2022-04-12"
output: html_document
---

# Introduction 

The goal of this assignment is to build a simple model to predict almond yield based on the paper by [Lobell et al. (2006)](https://www.sciencedirect.com/science/article/pii/S016819230600308X). 

# Set up: Load necessary libraries and scripts 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install packages if necessary, then load libraries
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}

librarian::shelf(
  here,
  lubridate,
  tidyverse)

#read in the almond_yield_anomaly and almond_yield_anomaly_annual R scripts in order to use the functions in this RMD 
source(here("functions", "almond_yield_anomaly.R"))
source(here("functions", "almond_yield_anomaly_annual.R"))
```

# Function description 

## Key
- `variable_name` = description [units]


## Inputs
- `temp` = average minimum temperature in February [degrees C]
- `precip` = average precipitation in January [mm]


## Parameters
- `temp_coeff1`
- `temp_coeff2`
- `precip_coeff1`
- `precip_coeff2`


## Outputs
- `almond_yield_anomaly` = almond yield anomaly [ton/acre]


# Test the simple `almond_yield_anomaly()` function 

```{r example}
almond_yield_anomaly(feb_temp_min = 25, 
                     jan_precip = 10)
```

# Read in climate data 

```{r}
# read in the data from .txt file
clim_raw <- read.csv(file = "clim.txt", 
                     header = T, 
                     sep = "")

# clean data 
clim_data <- clim_raw %>% 
             janitor::clean_names() %>% 
             mutate(d = lubridate::as_date(d), #convert d column to Date format rather than a character 
                    year = lubridate::year(d))
```

# Use the `almond_yield_anomaly()` function using coefficients from the paper 
```{r}
# set coefficient parameter values 
temp_coeff1 <- -0.015
temp_coeff2 <- -0.0046
precip_coeff1 <- -0.07
precip_coeff2 <- 0.0043
constant <- 0.28

## almond yield function, including Tmin February and Total January Precip
almond_yield_anomaly = function(feb_temp_min,
                                jan_precip,
                                temp_coeff1 = -0.015,
                                temp_coeff2 = -0.0046,
                                precip_coeff1 = -0.07,
                                precip_coeff2 = 0.0043,
                                constant = 0.28) {

#create a temperature data frame to summarize monthly temperature minimums by year
temp <- clim_data %>% 
  group_by(month, year) %>% 
  summarize(tmin_c=mean(tmin_c))

#extract the average minimum temperature for February 
tmin_feb = (temp %>% 
             filter(month==2))$tmin_c 

#create a precipitation data frame to summarize monthly precipitation averages by year 
precip <- clim_data %>% 
  group_by(month, year) %>% 
  summarize(precip =
              sum(precip))

#extract the average precipitation values for January 
precip_jan = (precip %>% 
          filter(month==1))$precip

#calculate almond yield anomaly 
almond_yield_anomaly =
  (temp_coeff1 * tmin_feb) + 
  (temp_coeff2 * tmin_feb**2) +
  (precip_coeff1 * precip_jan) + 
  (precip_coeff2 * precip_jan**2) + 
  constant

return(almond_yield_anomaly)
}
```


```{r}
# calculate annual almond yield for each year
annual_almond_yield <- cbind(unique(clim_data$year), almond_yield_anomaly(clim_data)) %>%  
  as.data.frame() %>% 
  rename(year = V1,
         yield = V2)

# plotting results
ggplot(annual_almond_yield, 
       aes(year, yield)) + 
  geom_line()+
  geom_point() +
  theme_bw() +
  labs(x = "Year", y = "Almond Yield (tons/acre)")
```



## Generalize temp and precip inputs


```{r}
temp = function(minimum, month_number){
  
  # minimum = TRUE for minimum value // FALSE for maximum value
  # month = number (out of 12) of month of interest
  
 if (minimum == TRUE){
   
   temp <- min(clim_txt_data$tmin_c[clim_txt_data$month == month_number])
   
} else if (minimum == FALSE){
  
  temp <- max(clim_txt_data$tmax_c[clim_txt_data$month == month_number]) 
  
} else {
  
  print("Error: must select TRUE (1) or FALSE (0) for minimum input")
  
}
  
  return(temp)
                        }
```



```{r}
precip = function(month){
  
  # month = number (out of 12) of month of interest
  
   
   precip <- mean(clim_txt_data$precip[clim_txt_data$month == month_number])
   
  
  return(precip)
                        }
```





